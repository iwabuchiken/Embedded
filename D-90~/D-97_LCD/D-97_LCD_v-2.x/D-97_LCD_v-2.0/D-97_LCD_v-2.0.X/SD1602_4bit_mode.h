#define _XTAL_FREQ 20000000

void SD1602_write(char c, char r)
{
  PORTB = c & 0xF0; /* RB4?RB7???????4bit?????? */

  if (r == 1) /* ???????? */
  {
    PORTA |= 0x02; /* RS?1??? */
  }
  else /* ???????? */
  {
    PORTA &= 0xFD; /* RS?0??? */
  }

  PORTA &= 0xFE; /* E?0??? */
  __delay_us(1); /* 1us?40ns???????? */
  PORTA |= 0x01; /* E?1??? */
  __delay_us(1);  /* 1us?230ns???????? */
  PORTA &= 0xFE; /* E?0??? */
}

void SD1602_display(char c)
{
  SD1602_write(c, 1); /* ????????4bit??? */
  SD1602_write(c << 4, 1); /* ????????4bit??? */
  __delay_us(50); /* 50us?40us???????? */
}

void SD1602_control(char c)
{
  SD1602_write(c, 0); /* ????????4bit??? */
  SD1602_write(c << 4, 0); /* ????????4bit??? */
  __delay_us(50); /* 50us?40us???????? */
}

void SD1602_clear(void)
{
  SD1602_write(0x01, 0); /* ????????4bit??? */
  SD1602_write(0x01 << 4, 0); /* ????????4bit??? */
  __delay_ms(2); /* 2ms?1.64ms???????? */
}

void SD1602_init(void)
{
  __delay_ms(20); /* 20ms?15ms???????? */
  SD1602_write(0x30, 0); /* 8bit????? */
  __delay_ms(5); /* 5ms?4.1ms???????? */
  SD1602_write(0x30, 0); /* 8bit????? */
  __delay_ms(5); /* 5ms?100us???????? */
  SD1602_write(0x30, 0); /* 8bit????? */
  __delay_ms(5); /* 5ms?4.1ms???????? */
  SD1602_write(0x20, 0); /* 4bit????? */
  __delay_ms(5); /* 5ms?40us???????? */
  SD1602_control(0x28); /* 4bit????2???????? */
  SD1602_control(0x08); /* ???????????? */
  SD1602_control(0x0C); /* ???????????? */
  SD1602_control(0x06); /* ??????????????? */
}

void SD1602_print(char *s)
{
  while (*s != 0x00) /* ?????0x00????????? */
  {
    SD1602_display(*s); /* ???????????? */
    s++;
  }
}
